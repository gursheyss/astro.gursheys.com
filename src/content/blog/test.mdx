---
layout: "@layouts/MarkdownLayout.astro"
title: "moving to astro with vercel and isr"
slug: "astro-with-vercel-and-isr"
date: 2024-05-10
---

i recently migrated this site from sveltekit to astro for a couple of reasons:

- i wanted better markdown support for this blog post you're reading right now.
  (i tried using mdsvex with sveltekit, but i couldn't quite get it to work the way i wanted.)
- i was looking to improve load times by taking advantage of astro's static html generation.

originally, i had the sveltekit version of this site deployed on vercel. however, i started to
notice some issues with cold starts, which were particularly noticeable since this site has
low traffic.

to address this, i moved my hosting over to railway.
while it was a bit slower than vercel when it came to fetching data from the server,
it got rid of the cold starts since it wasn't running in a serverless environment.

now that i've switched to astro, i was curious if i could get both the performance benefits
of static html but still have some dynamic content.

my home page is mostly static, but i have a music component showing my now playing
songs, playlists, and top tracks. with sveltekit, it was all server-rendered, so the
music info updated with each request.

my top tracks and playlists probably only
change every few days, but my now playing data needs to be almost live.

i found out about [vercel's isr](https://vercel.com/docs/incremental-static-regeneration)
and thought it would be perfect for this use case. i could cache the whole page
but have the now playing data update every few seconds.

i first thought of setting the isr expiration to 1 day and excluded the now playing api path. nope â€“
the whole page was cached, including the now playing data.

i got rid of isr and tried astro's hybrid rendering to server-render just the music
component, but that didn't work either since that's also on the page level

to comprimise, i made the component totally client-side, but it wasn't as
fast as i wanted since it had to fetch the data after the page loaded,
and since i'm using spotify's api, the speed was inconsistent.

there isn't much documentation on how to use astro with vercel and isr, or isr in
general with frameworks other than next.js

then i realized with isr, i could set the expiration really low, like 30 seconds.
when the cache expires, it serves a stale cached response and gets the new data in
the background. so everyone gets a cached response, but it automatically updates
every 30 seconds.

```js {4-8} showLineNumbers
// astro.config.mjs
export default defineConfig({
  integrations: [tailwind(), svelte()],
  output: "server",
  adapter: vercel({
    isr: {
      expiration: 30,
    },
  }),
});
```
